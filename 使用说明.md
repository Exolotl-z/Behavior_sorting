# 鼠标行为标记系统 使用说明

## 📋 目录
1. [系统简介](#系统简介)
2. [安装说明](#安装说明)
3. [快速开始](#快速开始)
4. [详细使用教程](#详细使用教程)
5. [数据分析功能](#数据分析功能)
6. [快捷键说明](#快捷键说明)
7. [常见问题](#常见问题)
8. [打包为exe文件](#打包为exe文件)

---

## 系统简介

鼠标行为标记系统是一款用于视频中鼠标行为分析的工具，主要功能包括：

✅ **视频播放与控制** - 支持多种视频格式，流畅的播放控制  
✅ **行为标记** - 实时标记鼠标行为的起始和结束时间  
✅ **时间线可视化** - 直观的时间线显示所有标记区间  
✅ **数据导出** - 自动保存为CSV格式，便于后续分析  
✅ **统计分析** - 内置数据可视化，生成统计图表  
✅ **用户友好** - 现代化界面，操作简单直观  

---

## 安装说明

### 方式一：使用Python运行（推荐开发者）

#### 1. 环境要求
- Python 3.8 或更高版本
- Windows 10/11 操作系统

#### 2. 安装依赖
双击运行 `install_dependencies.bat` 或在命令行中执行：
```bash
pip install -r requirements.txt
```

#### 3. 启动程序
双击运行 `运行程序.bat` 或在命令行中执行：
```bash
python Behavior_sorting\Behavior_sorting\Behavior_sorting\enhanced_main.py
```

### 方式二：使用打包的exe文件（推荐普通用户）

#### 1. 生成exe文件
双击运行 `build_exe.bat`，等待打包完成

#### 2. 运行程序
打包完成后，在 `dist` 文件夹中找到 `MouseBehaviorAnnotator.exe`，双击运行即可

---

## 快速开始

### 第一步：配置项目

1. 启动程序后，首先看到**设置窗口**
2. 点击"浏览..."选择要分析的视频文件
3. 输入**动物ID**（如：M01, M02等）
4. 输入**会话ID**（如：baseline, test等）
5. 设置**标记按键**（默认为'g'）
6. 设置**帧率**（默认30 Hz，设为0则自动读取视频帧率）
7. 点击"开始标记"

### 第二步：设置分析窗口

1. 视频窗口和控制面板会同时打开
2. 使用**空格键**暂停，拖动**时间线**到想要分析的起始位置
3. 点击"设置起始时间为当前时间"
4. 输入要分析的时长（单位：分钟）
5. 点击"开始标记(锁定窗口)"

### 第三步：标记行为

1. 视频会自动从起始位置开始播放
2. 当观察到目标行为开始时，按下**标记键**（默认'g'）
3. 当行为结束时，再次按下**标记键**
4. 绿色区域表示已标记的行为，红色表示正在标记中
5. 重复此过程标记所有行为

### 第四步：保存和分析

1. 标记完成后，点击"保存CSV"按钮
2. 数据会保存为 `动物ID_grooming.csv` 文件
3. 点击"查看数据分析"查看可视化统计结果
4. 点击"退出"关闭程序

---

## 详细使用教程

### 视频控制

#### 播放控制
- **空格键** 或 点击"暂停/继续"按钮：暂停/恢复播放
- **J键** 或 点击"后退5秒"：向后跳转5秒
- **L键** 或 点击"前进5秒"：向前跳转5秒

#### 时间线操作
- **拖动时间线**：点击并拖动视频下方的时间线，可以快速跳转到任意位置
- **白色竖线**：表示当前播放位置
- **绿色区域**：已标记并保存的行为区间
- **红色区域**：正在标记中的行为区间

#### 删除标记
- **右键点击时间线**：删除点击位置的标记区间

### 行为标记流程

#### 1. 预览阶段（未锁定窗口）
- 可以自由浏览整个视频
- 找到要分析的时间段
- 设置分析起始时间

#### 2. 标记阶段（锁定窗口后）
- 时间显示变为相对时间（从0开始）
- 只能在设定的时间窗口内标记
- 保存的CSV文件也使用相对时间

#### 3. 标记技巧
- 第一次按键：开始标记（显示红色）
- 第二次按键：结束标记（变为绿色）
- 如果标记错误，可以右键删除后重新标记
- 间隔小于0.2秒的标记会自动合并

### 数据导出格式

CSV文件包含以下列：
- `animal_id`: 动物ID
- `session_id`: 会话ID
- `start_s`: 行为开始时间（相对时间，秒）
- `end_s`: 行为结束时间（相对时间，秒）
- `duration_s`: 行为持续时间（秒）

示例：
```csv
animal_id,session_id,start_s,end_s,duration_s
M01,baseline,10.50,15.30,4.80
M01,baseline,25.60,30.20,4.60
```

---

## 数据分析功能

点击"查看数据分析"按钮，会打开包含4个标签页的分析窗口：

### 1. 统计摘要
显示详细的统计信息：
- 标记区间总数
- 总持续时间和百分比
- 平均、中位数、标准差
- 最短和最长持续时间
- 行为频率（次/分钟）

### 2. 持续时间分布
- **直方图**显示行为持续时间的分布情况
- 帮助识别行为模式

### 3. 时间线
- **横向条形图**显示所有行为在时间轴上的位置
- 直观展示行为发生的时间模式

### 4. 箱线图
- 显示持续时间的统计分布
- 包括中位数、四分位数、异常值等

---

## 快捷键说明

### 视频窗口和控制面板通用快捷键

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| **G** | 标记行为 | 开始/结束行为标记（可自定义） |
| **空格** | 暂停/继续 | 暂停或恢复视频播放 |
| **J** | 后退5秒 | 向后跳转5秒 |
| **L** | 前进5秒 | 向前跳转5秒 |
| **C** | 保存CSV | 保存标记数据 |
| **Q** | 退出 | 退出程序 |

### 鼠标操作

| 操作 | 功能 |
|------|------|
| **左键拖动时间线** | 快速跳转到指定时间 |
| **右键点击时间线** | 删除该位置的标记区间 |

---

## 常见问题

### Q1: 程序无法启动怎么办？
**A:** 
1. 确保已安装Python 3.8或更高版本
2. 运行 `install_dependencies.bat` 安装所有依赖
3. 检查是否有杀毒软件拦截

### Q2: 视频无法打开？
**A:**
1. 确认视频文件格式（推荐使用.avi, .mp4）
2. 检查视频文件是否损坏
3. 尝试使用其他视频播放器测试该文件

### Q3: 帧率不准确怎么办？
**A:**
在设置窗口中手动输入正确的帧率值（Hz）

### Q4: 如何修改标记按键？
**A:**
在设置窗口的"标记按键"输入框中修改（建议使用单个字母）

### Q5: 保存的CSV文件在哪里？
**A:**
CSV文件保存在程序运行目录下，文件名为 `动物ID_grooming.csv`

### Q6: 可以同时标记多个动物吗？
**A:**
建议为每个动物单独运行程序，使用不同的动物ID，这样会生成独立的CSV文件

### Q7: 数据可视化图表无法显示？
**A:**
1. 确保已安装matplotlib和seaborn
2. 检查是否至少标记了一个行为区间
3. 确认标记的区间在分析窗口内

### Q8: 如何处理大视频文件？
**A:**
1. 程序支持大文件，但加载可能较慢
2. 建议先用视频编辑软件裁剪到需要分析的部分
3. 降低视频分辨率可以提高流畅度

---

## 打包为exe文件

### 为什么要打包？
- 不需要安装Python环境
- 方便分享给不懂编程的用户
- 双击即可运行

### 打包步骤

#### 1. 安装打包工具
```bash
pip install pyinstaller
```

#### 2. 执行打包
双击运行 `build_exe.bat`，或在命令行执行：
```bash
pyinstaller --clean MouseBehaviorAnnotator.spec
```

#### 3. 找到exe文件
打包完成后，在 `dist` 文件夹中找到：
```
dist/
└── MouseBehaviorAnnotator.exe  ← 这就是可执行文件
```

#### 4. 分发程序
将 `MouseBehaviorAnnotator.exe` 复制给其他用户即可使用

### 打包注意事项
- 首次打包可能需要较长时间（5-15分钟）
- 生成的exe文件较大（约200-400MB），这是正常的
- exe文件可以在没有Python的Windows电脑上运行
- 如果杀毒软件报警，添加信任即可

---

## 技术支持

### 系统要求
- 操作系统：Windows 10/11
- Python版本：3.8 或更高（使用Python方式运行时）
- 内存：建议 4GB 以上
- 磁盘空间：至少 500MB 可用空间

### 依赖包版本
```
opencv-python==4.8.1.78
numpy==1.24.3
pandas==2.0.3
matplotlib==3.7.2
seaborn==0.12.2
Pillow==10.0.0
pyinstaller (仅打包时需要)
```

### 文件结构
```
Behavior_sorting/
├── Behavior_sorting/Behavior_sorting/Behavior_sorting/
│   ├── main_function.py           # 原始版本
│   └── enhanced_main.py           # 增强版本（推荐使用）
├── requirements.txt               # 依赖包列表
├── MouseBehaviorAnnotator.spec    # 打包配置
├── build_exe.bat                  # 打包脚本
├── 运行程序.bat                   # 快速启动脚本
├── install_dependencies.bat       # 依赖安装脚本
└── 使用说明.md                    # 本文档
```

---

## 更新日志

### v2.0 (增强版)
- ✨ 全新现代化界面设计
- ✨ 添加数据可视化分析功能
- ✨ 增加进度条显示
- ✨ 优化状态栏提示
- ✨ 支持更多视频格式
- ✨ 改进中文显示
- ✨ 添加详细使用说明
- ✨ 提供一键打包功能

### v1.0 (原始版)
- 基础视频播放功能
- 行为标记功能
- CSV数据导出

---

## 联系方式

如有问题或建议，请联系开发团队。

**祝您使用愉快！** 🎉
